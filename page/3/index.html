<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Página 3 | Rve</title>
  <meta name="author" content="李南均">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Rve"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70812759-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?cb5448498d7169c668b07c2b255d62c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Rve</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>归档
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>分类
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>标签
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>关于我
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>Rve<span class="blink-fast">∎</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart blink-slow"></i>
      Keep and carry on.
</div>    
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/12/18/android加密技术——dex加密/" >android加密技术——dex加密</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-12-18  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="&#x524D;&#x8A00;"><a href="#&#x524D;&#x8A00;" class="headerlink" title="&#x524D;&#x8A00;"></a>&#x524D;&#x8A00;</h2><p>dex&#x7684;&#x52A0;&#x5BC6;&#x5E94;&#x8BE5;&#x662F;android&#x52A0;&#x56FA;&#x4E2D;&#x975E;&#x5E38;&#x7B80;&#x5355;&#x7684;&#x52A0;&#x5BC6;&#x624B;&#x6BB5;&#x4E86;&#x5427;&#xFF01;&#x524D;&#x6BB5;&#x65F6;&#x95F4;&#x5728;&#x7F51;&#x4E0A;&#x770B;&#x535A;&#x5BA2;&#xFF0C;&#x5173;&#x4E8E;android&#x52A0;&#x56FA;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x65B9;&#x6CD5;&#xFF0C;&#x770B;&#x4E86;&#x4F5C;&#x8005;&#x7684;&#x4F8B;&#x5B50;&#x60F3;&#x8D77;&#x4E4B;&#x524D;&#x505A;&#x8FC7;&#x7684;&#x4E00;&#x9053;&#x534E;&#x5C71;&#x676F;&#x7684;&#x9898;&#x597D;&#x50CF;&#x4E5F;&#x662F;&#x5BF9;dex&#x8FDB;&#x884C;&#x52A0;&#x5BC6;&#xFF0C;&#x7136;&#x540E;&#x7FFB;&#x51FA;&#x6765;&#x53D1;&#x73B0;&#x8FD9;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#x4E00;&#x6A21;&#x4E00;&#x6837;&#xFF0C;&#x8FDE;&#x52A0;&#x5BC6;&#x7684;&#x65B9;&#x5F0F;&#x90FD;&#x662F;&#x5F02;&#x6216;0xff&#x3002;&#x6240;&#x4EE5;&#x4E3B;&#x8981;&#x5199;&#x4E00;&#x4E0B;&#x5B83;&#x7684;&#x5B9E;&#x73B0;&#x8FC7;&#x7A0B;&#xFF0C;&#x89E3;&#x9898;&#x601D;&#x8DEF;&#x90FD;&#x975E;&#x5E38;&#x7B80;&#x5355;&#x3002;</p>
<h2 id="dex&#x52A0;&#x56FA;&#x539F;&#x7406;"><a href="#dex&#x52A0;&#x56FA;&#x539F;&#x7406;" class="headerlink" title="dex&#x52A0;&#x56FA;&#x539F;&#x7406;"></a>dex&#x52A0;&#x56FA;&#x539F;&#x7406;</h2><p>1.&#x5F85;&#x52A0;&#x56FA;&#x7A0B;&#x5E8F;&#xFF08;apk&#xFF09;</p>
<p>2.&#x52A0;&#x5BC6;&#x7A0B;&#x5E8F;&#xFF08;java&#x5C42;&#x4EE3;&#x7801;&#xFF0C;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x63D0;&#x53D6;apk&#x4E2D;&#x7684;dex&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x52A0;&#x5BC6;dex&#x6587;&#x4EF6;&#xFF0C;&#x518D;&#x5C06;dex&#x6587;&#x4EF6;&#x548C;&#x89E3;&#x58F3;&#x7A0B;&#x5E8F;&#x5408;&#x5E76;&#x7136;&#x540E;&#x4FDD;&#x5B58;&#x5230;&#x65B0;&#x7684;dex&#x6587;&#x4EF6;&#x4E2D;&#xFF09;</p>
<p>3.&#x89E3;&#x58F3;&#x7A0B;&#x5E8F;</p>
<p><img src="/2016/12/18/android&#x52A0;&#x5BC6;&#x6280;&#x672F;&#x2014;&#x2014;dex&#x52A0;&#x5BC6;/1.png" alt="1"></p>
<p>&#x6E90;&#x7A0B;&#x5E8F;apk&#xFF1B;</p>
<p>&#x52A0;&#x58F3;&#x7A0B;&#x5E8F;&#xFF1A;</p>
<ol>
<li>&#x4EE5;&#x4E8C;&#x8FDB;&#x5236;&#x65B9;&#x5F0F;&#x8BFB;&#x51FA;&#x5F85;&#x52A0;&#x56FA;apk&#xFF0C;&#x5E76;&#x8FDB;&#x884C;&#x52A0;&#x5BC6;&#x5904;&#x7406;&#x3002;</li>
<li>&#x4EE5;&#x4E8C;&#x8FDB;&#x5236;&#x65B9;&#x5F0F;&#x8BFB;&#x51FA;&#x89E3;&#x58F3;dex&#x3002;</li>
<li>&#x521B;&#x5EFA;&#x4E8C;&#x8FDB;&#x5236;&#x6570;&#x7EC4;&#xFF0C;&#x5728;&#x7ED3;&#x5C3E;&#x589E;&#x52A0;4&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x5B58;&#x653E;&#x5F85;&#x52A0;&#x58F3;apk&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x62F7;&#x8D1D;dex&#x548C;apk&#x5230;&#x65B0;&#x7684;dex&#x4E2D;&#x3002;</li>
<li>&#x4FEE;&#x6539;DEX file size&#x6587;&#x4EF6;&#x5934;  &#xFF0C;&#x4FEE;&#x6539;DEX SHA1 &#x6587;&#x4EF6;&#x5934;  &#xFF0C;&#x4FEE;&#x6539;DEX CheckSum&#x6587;&#x4EF6;&#x5934; &#x3002;</li>
<li>&#x5C06;&#x4E8C;&#x8FDB;&#x5236;&#x6570;&#x7EC4;&#x5199;&#x5165;&#x5230;&#x65B0;&#x5EFA;&#x7684;dex&#x6587;&#x4EF6;&#x4E2D;&#x3002;</li>
</ol>
<p>&#x89E3;&#x58F3;&#x7A0B;&#x5E8F;&#xFF1A;</p>
<ol>
<li>&#x4ECE;apk&#x4E2D;&#x8BFB;&#x51FA;dex&#x6587;&#x4EF6;&#xFF0C;&#x7528;zipentry&#x5199;&#x5165;&#x5230;&#x4E8C;&#x8FDB;&#x5236;&#x6570;&#x7EC4;&#x4E2D;&#x3002;</li>
<li>&#x53D6;&#x88AB;&#x52A0;&#x58F3;apk&#x7684;&#x957F;&#x5EA6;&#xFF0C;&#x628A;&#x88AB;&#x52A0;&#x58F3;apk&#x5185;&#x5BB9;&#x62F7;&#x8D1D;&#x5230;newdex&#x4E2D; &#xFF0C;&#x5E76;&#x89E3;&#x5BC6;apk</li>
<li>&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x8BE5;dex&#x3002;</li>
</ol>
<p>&#x6574;&#x4E2A;&#x5B9E;&#x73B0;&#x7684;&#x6D41;&#x7A0B;&#x5982;&#x4E0A;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x628A;&#x534E;&#x5C71;&#x676F;&#x7684;Sheild.apk&#x62FF;&#x5230;jeb&#x4E2D;&#x770B;&#x4E00;&#x4E0B;&#x6E90;&#x7801;&#xFF0C;&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x5728;&#x505A;&#x9898;&#x8FC7;&#x7A0B;&#x4E2D;&#x52A0;&#x58F3;&#x7A0B;&#x5E8F;&#x4E0D;&#x662F;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8003;&#x8651;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x7528;&#x770B;&#x89E3;&#x58F3;&#x7A0B;&#x5E8F;&#x5E76;&#x4E14;&#x627E;&#x5230;&#x8FD9;&#x5176;&#x4E2D;&#x7684;&#x89E3;&#x5BC6;&#x7A0B;&#x5E8F;&#xFF0C;&#x4EE5;&#x53CA;&#x4EE3;&#x7801;&#x6BB5;&#x88AB;&#x52A0;&#x5BC6;&#x540E;&#x7684;&#x6570;&#x636E;&#x5373;&#x53EF;&#x3002;&#x8FD8;&#x662F;&#x5148;&#x628A;&#x4E0A;&#x8FF0;&#x6D41;&#x7A0B;&#x8F6C;&#x5316;&#x4E3A;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x4E00;&#x4E0B;&#x5427;&#x3002;</p>
<p><strong>&#x89E3;&#x58F3;&#x7A0B;&#x5E8F;</strong></p>
<p>&#x6B65;&#x9AA4;&#x4E00;&#xFF1A;&#x627E;&#x5230;apk&#x4E2D;&#x7684;dex&#x6587;&#x4EF6;&#xFF0C;&#x7528;&#x5230;ZipInputStream&#xFF0C;&#x521B;&#x5EFA;&#x4E24;&#x4E2A;&#x6587;&#x4EF6;&#x5939;&#x7528;&#x4E8E;&#x5B58;&#x50A8;apk&#x548C;so&#x6587;&#x4EF6;</p>
<p>&#x521B;&#x5EFA;&#x76EE;&#x5F55;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">//&#x521B;&#x5EFA;&#x4E24;&#x4E2A;&#x6587;&#x4EF6;&#x5939;payload_odex&#xFF0C;payload_lib &#x79C1;&#x6709;&#x7684;&#xFF0C;&#x53EF;&#x5199;&#x7684;&#x6587;&#x4EF6;&#x76EE;&#x5F55;  </div><div class="line">File odex = this.getDir(&quot;payload_odex&quot;, MODE_PRIVATE);  </div><div class="line">File libs = this.getDir(&quot;payload_lib&quot;, MODE_PRIVATE);  </div><div class="line">odexPath = odex.getAbsolutePath();  </div><div class="line">libPath = libs.getAbsolutePath();  </div><div class="line">apkFileName = odex.getAbsolutePath() + &quot;/payload.apk&quot;;  </div><div class="line">File dexFile = new File(apkFileName);  </div><div class="line">Log.i(&quot;demo&quot;, &quot;apk size:&quot;+dexFile.length());  </div><div class="line">if (!dexFile.exists())  </div><div class="line">{  </div><div class="line">   dexFile.createNewFile();  //&#x5728;payload_odex&#x6587;&#x4EF6;&#x5939;&#x5185;&#xFF0C;&#x521B;&#x5EFA;payload.apk  </div><div class="line">    // &#x8BFB;&#x53D6;&#x7A0B;&#x5E8F;classes.dex&#x6587;&#x4EF6;  </div><div class="line">    byte[] dexdata = this.readDexFileFromApk();  </div><div class="line">  </div><div class="line">    // &#x5206;&#x79BB;&#x51FA;&#x89E3;&#x58F3;&#x540E;&#x7684;apk&#x6587;&#x4EF6;&#x5DF2;&#x7528;&#x4E8E;&#x52A8;&#x6001;&#x52A0;&#x8F7D;  </div><div class="line">    this.splitPayLoadFromDex(dexdata);  </div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x4ECE;apk&#x4E2D;&#x83B7;&#x53D6;dex&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * &#x4ECE;apk&#x5305;&#x91CC;&#x9762;&#x83B7;&#x53D6;dex&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#xFF08;byte&#xFF09;</div><div class="line"> * @return</div><div class="line"> * @throws IOException</div><div class="line"> */</div><div class="line">private byte[] readDexFileFromApk() throws IOException {</div><div class="line">	ByteArrayOutputStream dexByteArrayOutputStream = new ByteArrayOutputStream();</div><div class="line">	ZipInputStream localZipInputStream = new ZipInputStream(</div><div class="line">			new BufferedInputStream(new FileInputStream(</div><div class="line">					this.getApplicationInfo().sourceDir)));</div><div class="line">	while (true) {</div><div class="line">		ZipEntry localZipEntry = localZipInputStream.getNextEntry();</div><div class="line">		if (localZipEntry == null) {</div><div class="line">			localZipInputStream.close();</div><div class="line">			break;</div><div class="line">		}</div><div class="line">		if (localZipEntry.getName().equals(&quot;classes.dex&quot;)) {</div><div class="line">			byte[] arrayOfByte = new byte[1024];</div><div class="line">			while (true) {</div><div class="line">				int i = localZipInputStream.read(arrayOfByte);</div><div class="line">				if (i == -1)</div><div class="line">					break;</div><div class="line">				dexByteArrayOutputStream.write(arrayOfByte, 0, i);</div><div class="line">			}</div><div class="line">		}</div><div class="line">		localZipInputStream.closeEntry();</div><div class="line">	}</div><div class="line">	localZipInputStream.close();</div><div class="line">	return dexByteArrayOutputStream.toByteArray();</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x4ECE;dex&#x4E2D;&#x5F97;&#x5230;&#x6E90;Apk&#x6587;&#x4EF6;&#xFF1A;System.arraycopy&#x590D;&#x5236;&#x5F85;&#x89E3;&#x5BC6;apk&#x6570;&#x636E;&#x5230;&#x6307;&#x5B9A;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x8FDB;&#x884C;&#x89E3;&#x5BC6;&#xFF0C;&#x5206;&#x6790;&#x89E3;&#x5BC6;&#x7684;apk&#x6587;&#x4EF6;&#xFF0C;&#x540C;&#x6837;&#x662F;&#x4F7F;&#x7528;ZipInputStream&#xFF0C;&#x5F97;&#x5230;apk&#x4E2D;&#x7684;dex&#x548C;so&#x6587;&#x4EF6;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">/** </div><div class="line"> * &#x91CA;&#x653E;&#x88AB;&#x52A0;&#x58F3;&#x7684;apk&#x6587;&#x4EF6;&#xFF0C;so&#x6587;&#x4EF6; </div><div class="line"> * @param data </div><div class="line"> * @throws IOException </div><div class="line"> */  </div><div class="line">private void splitPayLoadFromDex(byte[] apkdata) throws IOException {  </div><div class="line">    int ablen = apkdata.length;  </div><div class="line">    //&#x53D6;&#x88AB;&#x52A0;&#x58F3;apk&#x7684;&#x957F;&#x5EA6;   &#x8FD9;&#x91CC;&#x7684;&#x957F;&#x5EA6;&#x53D6;&#x503C;&#xFF0C;&#x5BF9;&#x5E94;&#x52A0;&#x58F3;&#x65F6;&#x957F;&#x5EA6;&#x7684;&#x8D4B;&#x503C;&#x90FD;&#x53EF;&#x4EE5;&#x505A;&#x4E9B;&#x7B80;&#x5316;  </div><div class="line">    byte[] dexlen = new byte[4];  </div><div class="line">    System.arraycopy(apkdata, ablen - 4, dexlen, 0, 4);  </div><div class="line">    ByteArrayInputStream bais = new ByteArrayInputStream(dexlen);  </div><div class="line">    DataInputStream in = new DataInputStream(bais);  </div><div class="line">    int readInt = in.readInt();  </div><div class="line">    System.out.println(Integer.toHexString(readInt));  </div><div class="line">    byte[] newdex = new byte[readInt];  </div><div class="line">    //&#x628A;&#x88AB;&#x52A0;&#x58F3;apk&#x5185;&#x5BB9;&#x62F7;&#x8D1D;&#x5230;newdex&#x4E2D;  </div><div class="line">    System.arraycopy(apkdata, ablen - 4 - readInt, newdex, 0, readInt);  </div><div class="line">    //&#x8FD9;&#x91CC;&#x5E94;&#x8BE5;&#x52A0;&#x4E0A;&#x5BF9;&#x4E8E;apk&#x7684;&#x89E3;&#x5BC6;&#x64CD;&#x4F5C;&#xFF0C;&#x82E5;&#x52A0;&#x58F3;&#x662F;&#x52A0;&#x5BC6;&#x5904;&#x7406;&#x7684;&#x8BDD;  </div><div class="line">    //?  </div><div class="line">      </div><div class="line">    //&#x5BF9;&#x6E90;&#x7A0B;&#x5E8F;Apk&#x8FDB;&#x884C;&#x89E3;&#x5BC6;  </div><div class="line">    newdex = decrypt(newdex);  </div><div class="line">      </div><div class="line">    //&#x5199;&#x5165;apk&#x6587;&#x4EF6;     </div><div class="line">    File file = new File(apkFileName);  </div><div class="line">    try {  </div><div class="line">        FileOutputStream localFileOutputStream = new FileOutputStream(file);  </div><div class="line">        localFileOutputStream.write(newdex);  </div><div class="line">        localFileOutputStream.close();  </div><div class="line">    } catch (IOException localIOException) {  </div><div class="line">        throw new RuntimeException(localIOException);  </div><div class="line">    }  </div><div class="line">      </div><div class="line">    //&#x5206;&#x6790;&#x88AB;&#x52A0;&#x58F3;&#x7684;apk&#x6587;&#x4EF6;  </div><div class="line">    ZipInputStream localZipInputStream = new ZipInputStream(  </div><div class="line">            new BufferedInputStream(new FileInputStream(file)));  </div><div class="line">    while (true) {  </div><div class="line">        ZipEntry localZipEntry = localZipInputStream.getNextEntry();//&#x4E0D;&#x4E86;&#x89E3;&#x8FD9;&#x4E2A;&#x662F;&#x5426;&#x4E5F;&#x904D;&#x5386;&#x5B50;&#x76EE;&#x5F55;&#xFF0C;&#x770B;&#x6837;&#x5B50;&#x5E94;&#x8BE5;&#x662F;&#x904D;&#x5386;&#x7684;  </div><div class="line">        if (localZipEntry == null) {  </div><div class="line">            localZipInputStream.close();  </div><div class="line">            break;  </div><div class="line">        }  </div><div class="line">        //&#x53D6;&#x51FA;&#x88AB;&#x52A0;&#x58F3;apk&#x7528;&#x5230;&#x7684;so&#x6587;&#x4EF6;&#xFF0C;&#x653E;&#x5230; libPath&#x4E2D;&#xFF08;data/data/&#x5305;&#x540D;/payload_lib)  </div><div class="line">        String name = localZipEntry.getName();  </div><div class="line">        if (name.startsWith(&quot;lib/&quot;) &amp;&amp; name.endsWith(&quot;.so&quot;)) {  </div><div class="line">            File storeFile = new File(libPath + &quot;/&quot;  </div><div class="line">                    + name.substring(name.lastIndexOf(&apos;/&apos;)));  </div><div class="line">            storeFile.createNewFile();  </div><div class="line">            FileOutputStream fos = new FileOutputStream(storeFile);  </div><div class="line">            byte[] arrayOfByte = new byte[1024];  </div><div class="line">            while (true) {  </div><div class="line">                int i = localZipInputStream.read(arrayOfByte);  </div><div class="line">                if (i == -1)  </div><div class="line">                    break;  </div><div class="line">                fos.write(arrayOfByte, 0, i);  </div><div class="line">            }  </div><div class="line">            fos.flush();  </div><div class="line">            fos.close();  </div><div class="line">        }  </div><div class="line">        localZipInputStream.closeEntry();  </div><div class="line">    }  </div><div class="line">    localZipInputStream.close();   </div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x6700;&#x540E;&#x662F;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x8FD0;&#x884C;&#x6211;&#x4EEC;&#x89E3;&#x5BC6;&#x51FA;&#x6765;&#x7684;apk</p>
<p>&#x5173;&#x952E;&#x7684;decrypt&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x627E;&#x5230;&#x540E;&#x5C31;&#x662F;&#x5BF9;&#x4EE3;&#x7801;&#x8FDB;&#x884C;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x5F02;&#x6216;0xff&#xFF0C;&#x6240;&#x4EE5;&#x6A21;&#x62DF;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x89E3;&#x5BC6;&#x5373;&#x53EF;&#x3002;</p>
<p><strong>&#x52A0;&#x58F3;&#x7A0B;&#x5E8F;</strong></p>
<p>&#x5BF9;&#x4E8E;&#x52A0;&#x58F3;&#x7A0B;&#x5E8F;&#x8981;&#x5BF9;dex&#x7684;&#x6587;&#x4EF6;&#x7ED3;&#x6784;&#x6709;&#x4E00;&#x4E2A;&#x5927;&#x6982;&#x7684;&#x4E86;&#x89E3;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x8981;&#x6D89;&#x53CA;&#x5230;&#x4FEE;&#x6539;&#x6587;&#x4EF6;&#x5934;&#x7684;&#x51E0;&#x4E2A;&#x5B57;&#x6BB5;&#x3002;</p>
<p>&#x5148;&#x6765;&#x770B;&#x4E00;&#x4E0B;dex&#x7684;&#x6587;&#x4EF6;&#x7ED3;&#x6784;</p>
<p><img src="/2016/12/18/android&#x52A0;&#x5BC6;&#x6280;&#x672F;&#x2014;&#x2014;dex&#x52A0;&#x5BC6;/2.png" alt="2"></p>
<p>&#x6211;&#x4EEC;&#x5728;&#x52A0;&#x58F3;&#x65F6;&#x9700;&#x8981;&#x4FEE;&#x6539;&#x4E0A;&#x56FE;&#x4E2D;&#xFF0C;&#x7EA2;&#x7EBF;&#x62EC;&#x8D77;&#x6765;&#x7684;&#x4E09;&#x4E2A;&#x90E8;&#x5206;&#xFF0C;&#x65B9;&#x6CD5;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>&#x4FEE;&#x6539;DEX CheckSum&#x6587;&#x4EF6;&#x5934;&#xFF0C;&#x4F7F;&#x7528;Adler32</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">/** </div><div class="line">     * &#x4FEE;&#x6539;dex&#x5934;&#xFF0C;CheckSum &#x6821;&#x9A8C;&#x7801; </div><div class="line">     * @param dexBytes </div><div class="line">     */  </div><div class="line">    private static void fixCheckSumHeader(byte[] dexBytes) {  </div><div class="line">        Adler32 adler = new Adler32();  </div><div class="line">        adler.update(dexBytes, 12, dexBytes.length - 12);//&#x4ECE;12&#x5230;&#x6587;&#x4EF6;&#x672B;&#x5C3E;&#x8BA1;&#x7B97;&#x6821;&#x9A8C;&#x7801;  </div><div class="line">        long value = adler.getValue();  </div><div class="line">        int va = (int) value;  </div><div class="line">        byte[] newcs = intToByte(va);  </div><div class="line">        //&#x9AD8;&#x4F4D;&#x5728;&#x524D;&#xFF0C;&#x4F4E;&#x4F4D;&#x5728;&#x524D;&#x6389;&#x4E2A;&#x4E2A;  </div><div class="line">        byte[] recs = new byte[4];  </div><div class="line">        for (int i = 0; i &lt; 4; i++) {  </div><div class="line">            recs[i] = newcs[newcs.length - 1 - i];  </div><div class="line">            System.out.println(Integer.toHexString(newcs[i]));  </div><div class="line">        }  </div><div class="line">        System.arraycopy(recs, 0, dexBytes, 8, 4);//&#x6548;&#x9A8C;&#x7801;&#x8D4B;&#x503C;&#xFF08;8-11&#xFF09;  </div><div class="line">        System.out.println(Long.toHexString(value));  </div><div class="line">        System.out.println();  </div><div class="line">    }</div></pre></td></tr></table></figure>
<p>&#x4FEE;&#x6539;DEX SHA1&#x6587;&#x4EF6;&#x5934;&#xFF0C;signature&#x90E8;&#x5206;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">/** </div><div class="line">    * &#x4FEE;&#x6539;dex&#x5934; sha1&#x503C; </div><div class="line">    * @param dexBytes </div><div class="line">    * @throws NoSuchAlgorithmException </div><div class="line">    */  </div><div class="line">   private static void fixSHA1Header(byte[] dexBytes)  </div><div class="line">           throws NoSuchAlgorithmException {  </div><div class="line">       MessageDigest md = MessageDigest.getInstance(&quot;SHA-1&quot;);  </div><div class="line">       md.update(dexBytes, 32, dexBytes.length - 32);//&#x4ECE;32&#x4E3A;&#x5230;&#x7ED3;&#x675F;&#x8BA1;&#x7B97;sha--1  </div><div class="line">       byte[] newdt = md.digest();  </div><div class="line">       System.arraycopy(newdt, 0, dexBytes, 12, 20);//&#x4FEE;&#x6539;sha-1&#x503C;&#xFF08;12-31&#xFF09;  </div><div class="line">       //&#x8F93;&#x51FA;sha-1&#x503C;&#xFF0C;&#x53EF;&#x6709;&#x53EF;&#x65E0;  </div><div class="line">       String hexstr = &quot;&quot;;  </div><div class="line">       for (int i = 0; i &lt; newdt.length; i++) {  </div><div class="line">           hexstr += Integer.toString((newdt[i] &amp; 0xff) + 0x100, 16)  </div><div class="line">                   .substring(1);  </div><div class="line">       }  </div><div class="line">       System.out.println(hexstr);  </div><div class="line">   }</div></pre></td></tr></table></figure>
<p>&#x4FEE;&#x6539;DEX file_size&#x6587;&#x4EF6;&#x5934;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/** </div><div class="line">    * &#x4FEE;&#x6539;dex&#x5934; file_size&#x503C; </div><div class="line">    * @param dexBytes </div><div class="line">    */  </div><div class="line">   private static void fixFileSizeHeader(byte[] dexBytes) {  </div><div class="line">       //&#x65B0;&#x6587;&#x4EF6;&#x957F;&#x5EA6;  </div><div class="line">       byte[] newfs = intToByte(dexBytes.length);  </div><div class="line">       System.out.println(Integer.toHexString(dexBytes.length));  </div><div class="line">       byte[] refs = new byte[4];  </div><div class="line">       //&#x9AD8;&#x4F4D;&#x5728;&#x524D;&#xFF0C;&#x4F4E;&#x4F4D;&#x5728;&#x524D;&#x6389;&#x4E2A;&#x4E2A;  </div><div class="line">       for (int i = 0; i &lt; 4; i++) {  </div><div class="line">           refs[i] = newfs[newfs.length - 1 - i];  </div><div class="line">           System.out.println(Integer.toHexString(newfs[i]));  </div><div class="line">       }  </div><div class="line">       System.arraycopy(refs, 0, dexBytes, 32, 4);//&#x4FEE;&#x6539;&#xFF08;32-35&#xFF09;  </div><div class="line">   }</div></pre></td></tr></table></figure>
<h2 id="Sheld-apk&#x89E3;&#x9898;&#x8FC7;&#x7A0B;"><a href="#Sheld-apk&#x89E3;&#x9898;&#x8FC7;&#x7A0B;" class="headerlink" title="Sheld.apk&#x89E3;&#x9898;&#x8FC7;&#x7A0B;"></a>Sheld.apk&#x89E3;&#x9898;&#x8FC7;&#x7A0B;</h2><p>&#x6211;&#x4EEC;&#x6253;&#x5F00;classes.dex</p>
<p><img src="/2016/12/18/android&#x52A0;&#x5BC6;&#x6280;&#x672F;&#x2014;&#x2014;dex&#x52A0;&#x5BC6;/3.png" alt="3"></p>
<p>&#x751F;&#x6210;&#x7684;dex&#x6587;&#x4EF6;&#xFF0C;&#x4E0A;&#x56FE;&#x4E2D;&#x9009;&#x4E2D;&#x90E8;&#x5206;&#x4E3A;20&#x5B57;&#x8282;&#x7684;signature</p>
<p>&#x6587;&#x4EF6;&#x672B;&#x5C3E;&#x4E3A;apk&#x6587;&#x4EF6;&#x5927;&#x5C0F;&#xFF1A;0x0004DAAC</p>
<p><img src="/2016/12/18/android&#x52A0;&#x5BC6;&#x6280;&#x672F;&#x2014;&#x2014;dex&#x52A0;&#x5BC6;/4.png" alt="4"></p>
<p>&#x52A0;&#x5BC6;&#x7684;&#x65B9;&#x6CD5;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x5206;&#x6790;&#x5B8C;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x89E3;&#x5BC6;&#x65F6;&#x53EA;&#x9700;&#x8981;&#x8BFB;&#x53D6;&#x6700;&#x540E;&#x56DB;&#x4F4D;&#x4E3A;&#x6574;&#x4E2A;&#x52A0;&#x5BC6;apk&#x957F;&#x5EA6;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x628A;&#x52A0;&#x5BC6;&#x540E;&#x7684;&#x4EE3;&#x7801;&#x8BFB;&#x53D6;&#x51FA;&#x6765;&#x8FDB;&#x884C;&#x89E3;&#x5BC6;&#xFF0C;&#x5B58;&#x5728;apk&#x6587;&#x4EF6;&#x4E2D;&#x5373;&#x53EF;&#xFF0C;&#x89E3;&#x5BC6;&#x811A;&#x672C;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">import binascii</div><div class="line">arr=&apos;&apos;</div><div class="line">f= open(&apos;classes.dex&apos;,&apos;rb&apos;)</div><div class="line">f.seek(0,0)</div><div class="line">while True:</div><div class="line">    byte=f.read(1)</div><div class="line">    if byte==&apos;&apos;:</div><div class="line">        break</div><div class="line">    else:</div><div class="line">        hexstr=byte</div><div class="line">    arr+=hexstr</div><div class="line">f.close()</div><div class="line">apksize=int(binascii.b2a_hex(arr[-4:]),16)</div><div class="line">apk_addr=apksize+4</div><div class="line">apkdata=arr[-apk_addr:-4]</div><div class="line"></div><div class="line">f2=open(&apos;original.apk&apos;,&apos;wb&apos;)</div><div class="line">for i in range(len(apkdata)):</div><div class="line">    f2.write(chr(ord(apkdata[i])^0xff))</div><div class="line">f2.close()</div></pre></td></tr></table></figure>
<p>&#x6700;&#x540E;&#x6211;&#x4EEC;&#x751F;&#x6210;&#x4E86;&#x4E00;&#x4E2A;orignal.apk&#x518D;&#x628A;&#x8FD9;&#x4E2A;apk&#x7834;&#x89E3;&#x5373;&#x53EF;&#xFF0C;&#x903B;&#x8F91;&#x975E;&#x5E38;&#x7B80;&#x5355;&#xFF0C;&#x53EA;&#x662F;&#x7B80;&#x5355;&#x7684;base64&#xFF0C;&#x5C31;&#x4E0D;&#x518D;&#x53D9;&#x8FF0;&#x4ED6;&#x7684;&#x89E3;&#x5BC6;&#x65B9;&#x6CD5;&#x4E86;&#x3002;</p>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>dex&#x52A0;&#x5BC6;&#x8F83;&#x4E3A;&#x7B80;&#x5355;&#xFF0C;&#x7279;&#x522B;&#x662F;&#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#x8FD8;&#x5C06;&#x4ED6;&#x653E;&#x5728;java&#x5C42;&#x5C31;&#x76F4;&#x63A5;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x770B;&#x4E86;&#x4ED6;&#x7684;&#x5B9E;&#x73B0;&#x8FC7;&#x7A0B;&#x8FD8;&#x662F;&#x611F;&#x89C9;&#x6BD4;&#x8F83;&#x6709;&#x6536;&#x83B7;&#xFF0C;&#x4E3B;&#x8981;&#x5728;&#x4E8E;&#x5B9E;&#x73B0;&#x8FC7;&#x7A0B;&#x4E2D;&#x4E0D;&#x4EC5;&#x4EC5;&#x662F;&#x5BF9;&#x52A0;&#x5BC6;&#x65B9;&#x6848;&#x7684;&#x8BBE;&#x8BA1;&#xFF0C;&#x8FD8;&#x9700;&#x8981;&#x5BF9;&#x6574;&#x4E2A;dex&#x6587;&#x4EF6;&#x7684;&#x89E3;&#x6790;&#xFF0C;&#x6587;&#x4EF6;&#x7ED3;&#x6784;&#xFF0C;&#x5B89;&#x5353;&#x7684;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x673A;&#x5236;&#x90FD;&#x8981;&#x719F;&#x7EC3;&#x638C;&#x63E1;&#xFF0C;&#x6240;&#x4EE5;&#x96BE;&#x70B9;&#x5E94;&#x8BE5;&#x662F;&#x5728;&#x5F00;&#x53D1;&#x8FD9;&#x4E00;&#x5757;&#x3002;&#x800C;&#x9006;&#x5411;&#x7684;&#x65F6;&#x5019;&#x5E76;&#x4E0D;&#x4F1A;&#x8003;&#x8651;&#x8FD9;&#x4E48;&#x591A;&#x3002;</p>

	
	</div>
  <a type="button" href="/2016/12/18/android加密技术——dex加密/#more" class="btn btn-default more">Leia Mais</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
     <a href="/page/2/" type="button" class="btn btn-default"><i class="fa fa-arrow-circle-o-left"></i> Anterior</a>
      

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/4/" type="button" class="btn btn-default ">Próximo<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Busca" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categorias</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/安全技术/">安全技术<span>5</span></a></li>
		
			<li><a href="/categories/机器学习/">机器学习<span>2</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/机器学习实战笔记/">机器学习实战笔记<span>2</span></a></li>
		
			<li><a href="/tags/第一篇博客/">第一篇博客<span>1</span></a></li>
		
			<li><a href="/tags/移动安全/">移动安全<span>5</span></a></li>
		
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Posts recentes</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2016/12/20/android加密技术——so文件加密/" ><i class="fa fa-file-o"></i>android加密技术——so文件加密</a>
      </li>
    
      <li>
        <a href="/2016/12/19/机器学习实战（二）决策树/" ><i class="fa fa-file-o"></i>机器学习实战（二）决策树</a>
      </li>
    
      <li>
        <a href="/2016/12/18/android加密技术——dex加密/" ><i class="fa fa-file-o"></i>android加密技术——dex加密</a>
      </li>
    
      <li>
        <a href="/2016/12/12/android-Java层和native层动态调试总结/" ><i class="fa fa-file-o"></i>android Java层和native层动态调试总结</a>
      </li>
    
      <li>
        <a href="/2016/12/08/朋友圈都转疯了！2016bctf带OLLVM混淆的LostFlower原来这样做！/" ><i class="fa fa-file-o"></i>朋友圈都转疯了！2016bctf带OLLVM混淆的Lo...</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="https://g479173199.github.io/" title="Freemind's Github repository." target="_blank"]);">Jieming&#39;s Blog</a></li>
	
		<li><i class="fa fa-github"></i><a href="" title="BOOTSTRA.386's Github repository." target="_blank"]);">BOOTSTRA.386</a></li>
	
		<li><i class="fa fa-github"></i><a href="" title="Freemind.386's Github repository." target="_blank"]);">Freemind.386</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2016 李南均
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.    
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
